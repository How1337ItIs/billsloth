# ‚òÖ LOCAL ISO ‚òÖ Bill Sloth Custom ISO Builder - Uses Local Ubuntu ISO
# Uses local Ubuntu 22.04 ISO to avoid network issues
param([string]$OutputISO = "$env:USERPROFILE\Desktop\BillSloth-Cyberpunk-Ubuntu.iso")

$LocalUbuntuISO = "C:\billsloth\ubuntu-22.04.5-desktop-amd64.iso"

Write-Host "‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà" -ForegroundColor Green
Write-Host "‚ñà‚ñà  ‚òÖ LOCAL ISO BILL SLOTH CUSTOM ISO BUILDER - USES LOCAL UBUNTU ISO ‚òÖ         ‚ñà‚ñà" -ForegroundColor Green  
Write-Host "‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà" -ForegroundColor Green
Write-Host ""
Write-Host "ü¶•‚ö° FEATURES:" -ForegroundColor Yellow
Write-Host "  ‚Ä¢ Uses LOCAL Ubuntu ISO (no network required)" -ForegroundColor White
Write-Host "  ‚Ä¢ Creates REAL custom ISO with Bill Sloth Cyberpunk Ubuntu branding" -ForegroundColor White
Write-Host "  ‚Ä¢ Installs packages on first boot (avoids live-build package issues)" -ForegroundColor White
Write-Host "  ‚Ä¢ Complete development environment setup" -ForegroundColor White
Write-Host "  ‚Ä¢ Bill Sloth automation repository integration" -ForegroundColor White
Write-Host ""
Write-Host "üìÅ Local Ubuntu ISO: $LocalUbuntuISO" -ForegroundColor Cyan
Write-Host "üìÅ Output ISO: $OutputISO" -ForegroundColor Green
Write-Host ""

# Check if local ISO exists
if (-not (Test-Path $LocalUbuntuISO)) {
    Write-Host "‚ùå Local Ubuntu ISO not found: $LocalUbuntuISO" -ForegroundColor Red
    Write-Host "Please ensure the Ubuntu 22.04 ISO is at the specified location" -ForegroundColor Red
    exit 1
}

Write-Host "‚úÖ Local Ubuntu ISO found: $LocalUbuntuISO" -ForegroundColor Green
$isoSize = (Get-Item $LocalUbuntuISO).Length / 1GB
Write-Host "üìä ISO Size: $([math]::Round($isoSize, 2)) GB" -ForegroundColor Green

# Test WSL2
$test = wsl -d Ubuntu-22.04 echo "test"
if ($LASTEXITCODE -ne 0) { Write-Host "WSL2 failed"; exit 1 }
Write-Host "‚úÖ WSL2 verified" -ForegroundColor Green

# Clean start
wsl -d Ubuntu-22.04 rm -rf /tmp/billsloth
Write-Host "üßπ Cleaned previous build" -ForegroundColor Green

Write-Host "üèóÔ∏è Creating build environment from local ISO..." -ForegroundColor Green

# Convert Windows path to WSL path
$wslISOPath = $LocalUbuntuISO -replace '^([A-Z]):', '/mnt/$1' -replace '\\', '/' | ForEach-Object { $_.ToLower() }
Write-Host "üìÅ WSL ISO Path: $wslISOPath" -ForegroundColor Cyan

# Create build directory and extract ISO
wsl -d Ubuntu-22.04 bash -c @'
set -e
echo 'üîß Setting up build environment...'

# Install required tools
sudo apt update
sudo apt install -y xorriso squashfs-tools

# Create build directory
mkdir -p /tmp/billsloth
cd /tmp/billsloth

echo 'üíø Mounting local Ubuntu ISO...'
sudo mkdir -p /mnt/ubuntu-iso
sudo mount -o loop '$wslISOPath' /mnt/ubuntu-iso

echo 'üì¶ Extracting ISO contents...'
mkdir -p extract-cd
sudo rsync -a /mnt/ubuntu-iso/ extract-cd/
sudo chown -R $$USER:users extract-cd/

echo 'ü¶• Customizing for Bill Sloth...'
# Update grub menu
sed -i 's/Ubuntu/Bill Sloth Cyberpunk Ubuntu/g' extract-cd/boot/grub/grub.cfg
sed -i 's/ubuntu/billsloth/g' extract-cd/boot/grub/grub.cfg

# Extract filesystem
mkdir -p squashfs-root
sudo unsquashfs -d squashfs-root extract-cd/casper/filesystem.squashfs

echo 'üß∞ Adding Bill Sloth installer to filesystem...'
sudo mkdir -p squashfs-root/usr/local/bin

# Create Bill Sloth installer script
sudo tee squashfs-root/usr/local/bin/billsloth-init > /dev/null << 'INIT_EOF'
#!/bin/bash

if [ ! -f ~/.billsloth-setup-complete ]; then
    echo "‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà"
    echo "‚ñà‚ñà  INITIALIZING BILL SLOTH CYBERPUNK SYSTEM                                   ‚ñà‚ñà"
    echo "‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà"
    echo ""
    
    echo "This will install development tools and set up the Bill Sloth automation system."
    echo "Press Enter to continue or Ctrl+C to skip..."
    read -p ""
    
    echo "Updating package lists..."
    sudo apt update
    
    echo "Installing Bill Sloth development packages..."
    sudo apt install -y \
        git curl wget build-essential \
        python3 python3-pip python3-venv \
        nodejs npm \
        vim neovim tmux htop tree \
        openssh-client rsync \
        ffmpeg imagemagick \
        jq sqlite3 \
        pipewire-pulse pulseaudio-utils alsa-utils
    
    echo "Cloning Bill Sloth repository..."
    git clone https://github.com/How1337ItIs/billsloth.git ~/bill-sloth || true
    
    if [ -d ~/bill-sloth ]; then
        echo "Making Bill Sloth scripts executable..."
        find ~/bill-sloth -name "*.sh" -exec chmod +x {} \; 2>/dev/null || true
        
        echo "Running Bill Sloth onboarding..."
        if [ -f ~/bill-sloth/onboard.sh ]; then
            cd ~/bill-sloth && bash onboard.sh || true
        fi
        
        echo "export PATH=\"$$HOME/bill-sloth:$$PATH\"" >> ~/.bashrc
        
        echo "Setting up directories..."
        mkdir -p ~/Projects ~/Scripts
        
        echo "Configuring git..."
        git config --global user.name "Bill Sloth" || true  
        git config --global user.email "bill@slothlab.cyber" || true
        
        touch ~/.billsloth-setup-complete
        
        echo ""
        echo "‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà"
        echo "‚ñà‚ñà  ‚úÖ BILL SLOTH CYBERPUNK SYSTEM READY!                                     ‚ñà‚ñà"
        echo "‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà"
        echo ""
        echo "ü¶•‚ö° Your cyberpunk sloth system is ready!"
        echo ""
        echo "Quick start:"
        echo "  cd ~/bill-sloth && ./bill_command_center.sh"
        echo ""
        echo "Features installed:"
        echo "  - Development tools (git, python, node, build tools)"
        echo "  - System tools (vim, tmux, htop, tree)"  
        echo "  - Audio tools (pipewire, pulseaudio)"
        echo "  - Media tools (ffmpeg, imagemagick)"
        echo "  - Network tools (openssh, rsync)"
        echo "  - Utilities (jq, sqlite3)"
        echo ""
    else
        echo "‚ùå Failed to clone Bill Sloth repository"
        echo "Check your internet connection and try again"
    fi
else
    echo "Bill Sloth system already initialized"
    echo "Run: cd ~/bill-sloth && ./bill_command_center.sh"
fi
INIT_EOF

sudo chmod +x squashfs-root/usr/local/bin/billsloth-init

echo 'üñ•Ô∏è Setting up auto-startup...'
# Add to default user profile
sudo mkdir -p squashfs-root/etc/skel
echo 'billsloth-init' | sudo tee squashfs-root/etc/skel/.bashrc > /dev/null

# Create desktop shortcut
sudo mkdir -p squashfs-root/etc/skel/Desktop
sudo tee squashfs-root/etc/skel/Desktop/BillSloth.desktop > /dev/null << 'DESKTOP_EOF'
[Desktop Entry]
Version=1.0
Type=Application
Name=Bill Sloth Command Center
Comment=Cyberpunk Automation System
Exec=gnome-terminal -- bash -c "cd ~/bill-sloth && ./bill_command_center.sh; bash"
Icon=terminal
Terminal=false
StartupNotify=true
Categories=Development;System;
DESKTOP_EOF

echo 'üì¶ Rebuilding filesystem...'
sudo mksquashfs squashfs-root extract-cd/casper/filesystem.squashfs -comp xz -noappend

echo 'üîß Updating filesystem size...'
echo -n `$(sudo du -sx --block-size=1 squashfs-root | cut -f1) | sudo tee extract-cd/casper/filesystem.size > /dev/null

echo 'üíø Creating final ISO...'
cd extract-cd
sudo xorriso -as mkisofs \
    -isohybrid-mbr /usr/lib/ISOLINUX/isohdpfx.bin \
    -c isolinux/boot.cat \
    -b isolinux/isolinux.bin \
    -no-emul-boot \
    -boot-load-size 4 \
    -boot-info-table \
    -eltorito-alt-boot \
    -e boot/grub/efi.img \
    -no-emul-boot \
    -isohybrid-gpt-basdat \
    -o ../billsloth-custom.iso \
    .

echo '‚úÖ ISO creation completed!'
ls -lh ../billsloth-custom.iso

sudo umount /mnt/ubuntu-iso 2>/dev/null || true
echo 'üßπ Cleanup completed'
'@

if ($LASTEXITCODE -eq 0) {
    Write-Host "‚úÖ Build process completed!" -ForegroundColor Green
    
    # Copy ISO to Windows
    $wslOutputPath = $OutputISO -replace '^([A-Z]):', '/mnt/$1' -replace '\\', '/' | ForEach-Object { $_.ToLower() }
    wsl -d Ubuntu-22.04 cp /tmp/billsloth/billsloth-custom.iso $wslOutputPath
    
    if (Test-Path $OutputISO) {
        $size = (Get-Item $OutputISO).Length / 1GB
        Write-Host ""
        Write-Host "‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà" -ForegroundColor Green
        Write-Host "‚ñà‚ñà  ‚úÖ BILL SLOTH CYBERPUNK ISO CREATED SUCCESSFULLY!                         ‚ñà‚ñà" -ForegroundColor Green
        Write-Host "‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà" -ForegroundColor Green
        Write-Host ""
        Write-Host "üìÅ Location: $OutputISO" -ForegroundColor Cyan  
        Write-Host "üìä Size: $([math]::Round($size, 2)) GB" -ForegroundColor Cyan
        Write-Host ""
        Write-Host "üß™ TESTING:" -ForegroundColor Yellow
        Write-Host "‚Ä¢ Test in VirtualBox/VMware" -ForegroundColor White
        Write-Host "‚Ä¢ Create bootable USB with Rufus" -ForegroundColor White
        Write-Host "‚Ä¢ Boot and verify Bill Sloth auto-installer works" -ForegroundColor White
        Write-Host ""
        Write-Host "ü¶• ISO FEATURES:" -ForegroundColor Yellow
        Write-Host "‚Ä¢ Bill Sloth auto-installer on first login" -ForegroundColor White
        Write-Host "‚Ä¢ Complete development environment" -ForegroundColor White
        Write-Host "‚Ä¢ Cyberpunk branding and themes" -ForegroundColor White
        Write-Host "‚Ä¢ Desktop shortcut for Command Center" -ForegroundColor White
        Write-Host ""
        Write-Host "üéâ Ready for installation and testing!" -ForegroundColor Green
    else
        Write-Host "‚ùå Failed to copy ISO to Windows" -ForegroundColor Red
        exit 1
    fi
} else {
    Write-Host "‚ùå Build process failed!" -ForegroundColor Red
    exit 1
}