#!/bin/bash
# Professional Tools Upgrade - Replace amateur tools with enterprise alternatives
# "Time to upgrade from stone-age meat-puppet tools to professional supremacy!" - Carl

set -euo pipefail

source "$(dirname "$0")/../lib/include_loader.sh"
load_includes "core" "notification" "error_handling"

LOG_FILE="$HOME/.bill-sloth/logs/professional_upgrade.log"
mkdir -p "$(dirname "$LOG_FILE")"

log_upgrade() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

show_banner() {
    echo -e "\033[38;5;196m"
    cat << 'EOF'
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  
    â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  
    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•    â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘     â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
    â•šâ•â•     â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â•      â•šâ•â•â•â•â•â• â•šâ•â•      â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•
EOF
    echo -e "\033[0m"
}

upgrade_audio_system() {
    log_upgrade "ğŸµ Upgrading audio system to PipeWire..."
    
    if command -v pipewire >/dev/null 2>&1; then
        log_upgrade "âœ… PipeWire already installed"
        return
    fi
    
    # Install PipeWire (modern audio server)
    sudo apt update
    sudo apt install -y pipewire pipewire-alsa pipewire-pulse pipewire-jack-audio-connection-kit
    sudo apt install -y wireplumber pipewire-media-session-
    
    # Professional audio tools
    sudo apt install -y \
        carla \
        qpwgraph \
        helvum \
        pavucontrol \
        pulseeffects \
        lsp-plugins \
        calf-plugins \
        x42-plugins
    
    # Enable PipeWire services
    systemctl --user --now enable pipewire pipewire-pulse
    systemctl --user --now enable wireplumber
    
    log_upgrade "âœ… Professional audio system (PipeWire) installed"
}

upgrade_backup_system() {
    log_upgrade "ğŸ’¾ Upgrading backup system to Borg..."
    
    if command -v borg >/dev/null 2>&1; then
        log_upgrade "âœ… Borg already installed"
        return
    fi
    
    # Install Borg Backup (professional backup solution)
    sudo apt install -y borgbackup
    
    # Install Restic as alternative
    sudo apt install -y restic
    
    # Create professional backup script
    cat > "$HOME/bin/bill-backup-pro" << 'EOF'
#!/bin/bash
# Professional Backup System using Borg

BACKUP_DIR="$HOME/.bill-sloth-backups"
BORG_REPO="$BACKUP_DIR/borg-repo"
DATE=$(date +%Y-%m-%d_%H-%M-%S)

# Initialize repository if not exists
if [ ! -d "$BORG_REPO" ]; then
    borg init --encryption=repokey "$BORG_REPO"
fi

# Create backup
borg create \
    --stats --progress \
    "$BORG_REPO::bill-sloth-{now}" \
    "$HOME/.bill-sloth" \
    "$HOME/bill sloth" \
    --exclude '*.log' \
    --exclude 'cache/*' \
    --exclude 'tmp/*'

# Prune old backups (keep 7 daily, 4 weekly, 6 monthly)
borg prune \
    --keep-daily=7 \
    --keep-weekly=4 \
    --keep-monthly=6 \
    "$BORG_REPO"

echo "âœ… Professional backup complete: $DATE"
EOF
    
    chmod +x "$HOME/bin/bill-backup-pro"
    log_upgrade "âœ… Professional backup system (Borg) installed"
}

upgrade_task_scheduling() {
    log_upgrade "â° Upgrading task scheduling to systemd timers..."
    
    # Create systemd user directory
    mkdir -p "$HOME/.config/systemd/user"
    
    # Professional backup timer
    cat > "$HOME/.config/systemd/user/bill-backup.service" << 'EOF'
[Unit]
Description=Bill Sloth Professional Backup
After=network.target

[Service]
Type=oneshot
ExecStart=%h/bin/bill-backup-pro
User=%i
EOF
    
    cat > "$HOME/.config/systemd/user/bill-backup.timer" << 'EOF'
[Unit]
Description=Run Bill Sloth backup daily
Requires=bill-backup.service

[Timer]
OnCalendar=daily
Persistent=true

[Install]
WantedBy=timers.target
EOF
    
    # VRBO sync timer
    cat > "$HOME/.config/systemd/user/vrbo-sync.service" << 'EOF'
[Unit]
Description=VRBO Data Synchronization
After=network.target

[Service]
Type=oneshot
ExecStart=/bin/bash -c 'curl -X POST http://localhost:8000/sync-bookings'
User=%i
EOF
    
    cat > "$HOME/.config/systemd/user/vrbo-sync.timer" << 'EOF'
[Unit]
Description=Sync VRBO data every hour
Requires=vrbo-sync.service

[Timer]
OnCalendar=hourly
Persistent=true

[Install]
WantedBy=timers.target
EOF
    
    # Enable timers
    systemctl --user daemon-reload
    systemctl --user enable --now bill-backup.timer
    systemctl --user enable --now vrbo-sync.timer
    
    log_upgrade "âœ… Professional task scheduling (systemd timers) configured"
}

upgrade_monitoring_system() {
    log_upgrade "ğŸ“Š Installing professional monitoring tools..."
    
    # Install system monitoring tools
    sudo apt install -y \
        htop \
        btop \
        iotop \
        nethogs \
        glances \
        ncdu \
        tree \
        fd-find \
        ripgrep \
        bat \
        exa \
        zoxide
    
    # Create professional aliases
    cat >> "$HOME/.bill-sloth/aliases.sh" << 'EOF'

# Professional tool aliases
alias ls='exa --icons --group-directories-first'
alias ll='exa -la --icons --group-directories-first'
alias cat='bat --style=auto'
alias find='fd'
alias grep='rg'
alias cd='z'  # zoxide smart cd
alias top='btop'
alias du='ncdu'

# Professional shortcuts
alias bill-status='glances'
alias bill-logs='journalctl --user -f'
alias bill-services='systemctl --user status'
EOF
    
    log_upgrade "âœ… Professional monitoring tools installed"
}

upgrade_development_tools() {
    log_upgrade "ğŸ› ï¸ Installing professional development environment..."
    
    # Modern Python
    sudo apt install -y python3.11 python3.11-venv python3.11-dev python3-pip
    
    # Node.js LTS
    curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
    sudo apt-get install -y nodejs
    
    # Modern Git configuration
    git config --global init.defaultBranch main
    git config --global pull.rebase true
    git config --global core.autocrlf input
    
    # Professional text editors
    sudo apt install -y neovim code
    
    log_upgrade "âœ… Professional development environment configured"
}

upgrade_network_tools() {
    log_upgrade "ğŸŒ Installing professional network tools..."
    
    sudo apt install -y \
        nmap \
        wireshark-qt \
        tcpdump \
        netstat-nat \
        ss \
        iperf3 \
        mtr \
        dig \
        whois \
        curl \
        wget2
    
    # Professional network monitoring
    cat > "$HOME/bin/bill-network-status" << 'EOF'
#!/bin/bash
# Professional network monitoring dashboard

echo "ğŸŒ BILL SLOTH NETWORK STATUS DASHBOARD"
echo "======================================"
echo ""

echo "ğŸ“Š INTERFACE STATUS:"
ip -c addr show | grep -E "(^\d|inet )"
echo ""

echo "ğŸ”— ACTIVE CONNECTIONS:"
ss -tulpn | head -10
echo ""

echo "ğŸ“ˆ BANDWIDTH USAGE:"
if command -v vnstat >/dev/null; then
    vnstat -i $(ip route | grep default | awk '{print $5}' | head -1) -d -l 1
else
    echo "Install vnstat for bandwidth statistics"
fi
echo ""

echo "ğŸ¯ DOCKER SERVICES:"
docker compose ps 2>/dev/null || echo "Docker services not running"
EOF
    
    chmod +x "$HOME/bin/bill-network-status"
    log_upgrade "âœ… Professional network tools installed"
}

main_upgrade() {
    clear
    show_banner
    
    echo -e "\033[38;5;46mğŸ’€ PROFESSIONAL TOOLS UPGRADE - TRANSCEND AMATEUR LIMITATIONS ğŸ’€\033[0m"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "ğŸ¯ UPGRADE TO ENTERPRISE-GRADE TOOLS:"
    echo "â€¢ Replace PulseAudio â†’ PipeWire (professional audio)"
    echo "â€¢ Replace cron â†’ systemd timers (reliable scheduling)"
    echo "â€¢ Replace basic tools â†’ professional alternatives"
    echo "â€¢ Add monitoring, backup, and automation"
    echo ""
    
    log_upgrade "ğŸš€ Starting professional tools upgrade..."
    
    echo "ğŸ”§ PROFESSIONAL UPGRADES IN PROGRESS:"
    echo ""
    
    upgrade_audio_system
    echo "âœ… Audio system upgraded to PipeWire"
    
    upgrade_backup_system  
    echo "âœ… Backup system upgraded to Borg"
    
    upgrade_task_scheduling
    echo "âœ… Task scheduling upgraded to systemd"
    
    upgrade_monitoring_system
    echo "âœ… Monitoring tools installed"
    
    upgrade_development_tools
    echo "âœ… Development environment modernized"
    
    upgrade_network_tools
    echo "âœ… Network tools professionalized"
    
    echo ""
    echo "ğŸ‰ PROFESSIONAL UPGRADE COMPLETE!"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "ğŸ§  Carl: 'Now you're operating with professional-grade equipment!'"
    echo ""
    echo "âœ… WHAT'S NEW:"
    echo "â€¢ PipeWire for broadcast-quality audio"
    echo "â€¢ Borg for military-grade backups"
    echo "â€¢ systemd timers for reliable automation"
    echo "â€¢ Professional monitoring dashboard"
    echo "â€¢ Enterprise development tools"
    echo ""
    echo "ğŸ¯ NEXT STEPS:"
    echo "â€¢ Run: bill-network-status (network dashboard)"
    echo "â€¢ Run: bill-backup-pro (create backup)"
    echo "â€¢ Check: systemctl --user status (service status)"
    echo ""
    
    log_upgrade "âœ… Professional tools upgrade completed successfully"
}

# Run the upgrade
main_upgrade