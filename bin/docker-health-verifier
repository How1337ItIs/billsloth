#!/bin/bash
# Docker Health Verifier - Ensure all business services actually work
# "Time to make sure our digital empire isn't just smoke and mirrors!" - Carl  

set -euo pipefail

source "$(dirname "$0")/../lib/include_loader.sh"
load_includes "core" "notification" "error_handling"

LOG_FILE="$HOME/.bill-sloth/logs/docker_health.log"
mkdir -p "$(dirname "$LOG_FILE")"

log_health() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

show_banner() {
    echo -e "\033[38;5;51m"
    cat << 'EOF'
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—
    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘
    â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
    â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘
    â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•    â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•   â•šâ•â•  â•šâ•â•
EOF
    echo -e "\033[0m"
}

check_docker_installation() {
    log_health "ğŸ³ Checking Docker installation..."
    
    if ! command -v docker >/dev/null 2>&1; then
        log_health "âŒ Docker not installed"
        echo "Installing Docker..."
        source "$(dirname "$0")/../setup-scripts/install_docker.sh"
    else
        log_health "âœ… Docker installed"
    fi
    
    # Check Docker daemon
    if ! docker info >/dev/null 2>&1; then
        log_health "âŒ Docker daemon not running"
        echo "Starting Docker daemon..."
        sudo systemctl start docker
        sudo systemctl enable docker
        
        # Add user to docker group if not already
        if ! groups | grep -q docker; then
            sudo usermod -aG docker $USER
            log_health "âš ï¸ Added user to docker group - logout/login required"
        fi
    else
        log_health "âœ… Docker daemon running"
    fi
}

verify_compose_file() {
    log_health "ğŸ“‹ Verifying Docker Compose configuration..."
    
    local compose_file="$(dirname "$0")/../docker-compose.yml"
    
    if [ ! -f "$compose_file" ]; then
        log_health "âŒ Docker Compose file missing"
        return 1
    fi
    
    # Validate compose file syntax
    if docker compose -f "$compose_file" config >/dev/null 2>&1; then
        log_health "âœ… Docker Compose file valid"
    else
        log_health "âŒ Docker Compose file invalid"
        echo "Docker Compose validation errors:"
        docker compose -f "$compose_file" config
        return 1
    fi
    
    # Check for required directories
    local project_root="$(dirname "$0")/.."
    local required_dirs=(
        "data/vrbo"
        "data/analytics"  
        "data/communications"
        "logs/vrbo"
        "logs/communications"
        "docker/vrbo-automation"
        "docker/guest-communication"
    )
    
    for dir in "${required_dirs[@]}"; do
        if [ ! -d "$project_root/$dir" ]; then
            log_health "ğŸ“ Creating missing directory: $dir"
            mkdir -p "$project_root/$dir"
        fi
    done
    
    log_health "âœ… Directory structure verified"
}

start_services() {
    log_health "ğŸš€ Starting Docker services..."
    
    local project_root="$(dirname "$0")/.."
    cd "$project_root"
    
    # Start services
    if docker compose up -d; then
        log_health "âœ… Docker services started"
    else
        log_health "âŒ Failed to start Docker services"
        return 1
    fi
    
    # Wait for services to initialize
    log_health "â³ Waiting for services to initialize..."
    sleep 15
}

verify_service_health() {
    local service_name="$1"
    local health_url="$2"
    local expected_response="$3"
    
    log_health "ğŸ” Checking $service_name health..."
    
    local retries=10
    while [ $retries -gt 0 ]; do
        if curl -s -f "$health_url" | grep -q "$expected_response" 2>/dev/null; then
            log_health "âœ… $service_name healthy"
            return 0
        fi
        
        log_health "â³ Waiting for $service_name... ($retries retries left)"
        sleep 3
        ((retries--))
    done
    
    log_health "âŒ $service_name health check failed"
    return 1
}

verify_all_services() {
    log_health "ğŸ©º Verifying all service health..."
    
    local failed_services=0
    
    # Check PostgreSQL
    if docker compose exec -T postgres pg_isready -U bill >/dev/null 2>&1; then
        log_health "âœ… PostgreSQL healthy"
    else
        log_health "âŒ PostgreSQL not responding"
        ((failed_services++))
    fi
    
    # Check Redis
    if docker compose exec -T redis redis-cli ping | grep -q "PONG"; then
        log_health "âœ… Redis healthy"
    else
        log_health "âŒ Redis not responding"
        ((failed_services++))
    fi
    
    # Check Grafana
    if verify_service_health "Grafana" "http://localhost:3000/login" "Grafana"; then
        true
    else
        ((failed_services++))
    fi
    
    # Check Kanboard
    if verify_service_health "Kanboard" "http://localhost:8081" "Kanboard"; then
        true
    else
        ((failed_services++))
    fi
    
    # Check if custom services would be running (they need to be built first)
    if docker compose ps | grep -q "vrbo-automation"; then
        if verify_service_health "VRBO Automation" "http://localhost:8000/health" "healthy"; then
            true
        else
            ((failed_services++))
        fi
    else
        log_health "âš ï¸ VRBO Automation service not built yet"
    fi
    
    return $failed_services
}

fix_common_issues() {
    log_health "ğŸ”§ Fixing common Docker issues..."
    
    # Fix permissions
    local project_root="$(dirname "$0")/.."
    sudo chown -R $USER:$USER "$project_root/data" "$project_root/logs" 2>/dev/null || true
    
    # Prune unused resources
    docker system prune -f >/dev/null 2>&1 || true
    
    # Restart networking
    docker network prune -f >/dev/null 2>&1 || true
    
    log_health "âœ… Common issues fixed"
}

generate_health_report() {
    log_health "ğŸ“Š Generating health report..."
    
    local report_file="$HOME/.bill-sloth/reports/docker_health_$(date +%Y%m%d_%H%M%S).txt"
    mkdir -p "$(dirname "$report_file")"
    
    cat > "$report_file" << EOF
BILL SLOTH DOCKER HEALTH REPORT
Generated: $(date)
================================

DOCKER ENGINE:
$(docker version --format 'Client: {{.Client.Version}}, Server: {{.Server.Version}}' 2>/dev/null || echo "Docker not available")

RUNNING SERVICES:
$(docker compose ps 2>/dev/null || echo "No compose services")

SYSTEM RESOURCES:
$(docker system df 2>/dev/null || echo "Resource info unavailable")

NETWORKS:
$(docker network ls --format 'table {{.Name}}\t{{.Driver}}\t{{.Scope}}' 2>/dev/null || echo "Network info unavailable")

VOLUMES:
$(docker volume ls --format 'table {{.Name}}\t{{.Driver}}' 2>/dev/null || echo "Volume info unavailable")

SERVICE ENDPOINTS:
â€¢ Grafana Dashboard: http://localhost:3000 (admin/bill_sloth_2025)
â€¢ Kanboard: http://localhost:8081 (admin/admin)
â€¢ PostgreSQL: localhost:5432 (bill/sloth_secure_2025)
â€¢ Redis: localhost:6379

HEALTH STATUS:
$([ -f "$LOG_FILE" ] && tail -10 "$LOG_FILE" || echo "No health logs available")
EOF
    
    log_health "ğŸ“„ Health report saved to: $report_file"
    echo "ğŸ“„ Full report: $report_file"
}

main_verification() {
    clear
    show_banner
    
    echo -e "\033[38;5;51mğŸ©º DOCKER HEALTH VERIFICATION - ENSURING BUSINESS SERVICES WORK ğŸ©º\033[0m"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "ğŸ¯ VERIFYING DOCKER INFRASTRUCTURE:"
    echo "â€¢ Docker installation and daemon"
    echo "â€¢ Compose file validation"
    echo "â€¢ Service startup and health"
    echo "â€¢ Database connectivity"
    echo "â€¢ Web interface availability"
    echo ""
    
    log_health "ğŸš€ Starting Docker health verification..."
    
    # Run verification steps
    check_docker_installation
    echo "âœ… Docker installation verified"
    
    verify_compose_file
    echo "âœ… Compose configuration verified"
    
    start_services
    echo "âœ… Services started"
    
    if verify_all_services; then
        echo "âœ… All services healthy"
        health_status="ALL SYSTEMS OPERATIONAL"
    else
        echo "âš ï¸ Some services need attention"
        health_status="PARTIAL FUNCTIONALITY"
        
        # Try to fix common issues
        fix_common_issues
        
        # Retry verification
        if verify_all_services; then
            echo "âœ… Issues resolved"
            health_status="ALL SYSTEMS OPERATIONAL"
        fi
    fi
    
    generate_health_report
    
    echo ""
    echo "ğŸ‰ DOCKER HEALTH VERIFICATION COMPLETE!"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "ğŸ§  Carl: 'Your digital empire's infrastructure is solid!'"
    echo ""
    echo "ğŸ“Š OVERALL STATUS: $health_status"
    echo ""
    echo "ğŸŒ ACCESS YOUR SERVICES:"
    echo "â€¢ Business Dashboard: http://localhost:3000"
    echo "â€¢ Project Management: http://localhost:8081"
    echo "â€¢ Database: localhost:5432"
    echo ""
    echo "ğŸ”§ MANAGEMENT COMMANDS:"
    echo "â€¢ View logs: docker compose logs"
    echo "â€¢ Restart services: docker compose restart"
    echo "â€¢ Stop services: docker compose down"
    echo "â€¢ Update services: docker compose pull && docker compose up -d"
    echo ""
    
    log_health "âœ… Docker health verification completed: $health_status"
}

# Run verification
main_verification