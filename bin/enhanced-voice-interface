#!/bin/bash
# Enhanced Bill Sloth Voice Interface with Claude Bridge Integration
# LLM_CAPABILITY: local_ok

echo "ðŸŽ¤ ENHANCED BILL SLOTH VOICE INTERFACE"
echo "======================================"
echo ""
echo "ðŸ¤– Claude Bridge: ACTIVE"
echo "ðŸŽ™ï¸ Voice Control: READY"
echo "ðŸ§  Smart Automation: ENABLED"
echo ""

# Load the Claude Interactive Bridge
SOURCE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
source "$SOURCE_DIR/lib/claude_interactive_bridge.sh" 2>/dev/null || true

# Check if Linux Voice Control is available
if [[ -f "$SOURCE_DIR/external/linux-voice-control/main.py" ]]; then
    echo "âœ… Linux Voice Control detected"
    VOICE_CONTROL_AVAILABLE=true
else
    echo "âš ï¸ Linux Voice Control not found - using text input mode"
    VOICE_CONTROL_AVAILABLE=false
fi

# Enhanced voice command categories
show_voice_commands() {
    echo "ðŸŽ¯ VOICE COMMAND CATEGORIES:"
    echo ""
    echo "ðŸ¤– AI & AUTOMATION:"
    echo "   â€¢ 'ai mastery' - AI tools and local models"
    echo "   â€¢ 'ai workflow' - AI automation workflows"
    echo "   â€¢ 'automation advisor' - Smart automation setup"
    echo ""
    echo "ðŸ› ï¸ SYSTEM & TOOLS:"
    echo "   â€¢ 'automation mastery' - Complete automation control"
    echo "   â€¢ 'file management' - Advanced file operations"
    echo "   â€¢ 'system doctor' - Health checks and diagnostics"
    echo "   â€¢ 'security tools' - Defensive cyber security"
    echo ""
    echo "ðŸŽ® ENTERTAINMENT & PRODUCTIVITY:"
    echo "   â€¢ 'gaming boost' - Gaming optimization"
    echo "   â€¢ 'streaming setup' - Content creation tools"
    echo "   â€¢ 'privacy tools' - Privacy protection"
    echo "   â€¢ 'creative coding' - Development environment"
    echo ""
    echo "ðŸ’¼ BUSINESS & DATA:"
    echo "   â€¢ 'vacation rental' - VRBO property management"
    echo "   â€¢ 'data hoarding' - Data management and backup"
    echo "   â€¢ 'edboy games' - EdBoiGames business tools"
    echo ""
    echo "ðŸš€ SYSTEM COMMANDS:"
    echo "   â€¢ 'bill command center' - Main control center"
    echo "   â€¢ 'health check' - System health diagnostics"
    echo "   â€¢ 'voice bridge test' - Test bridge integration"
    echo ""
}

# Voice command processor with bridge integration
process_voice_command() {
    local command="$1"
    local config_file="$SOURCE_DIR/external/bill-sloth-voice-config.json"
    
    if [[ ! -f "$config_file" ]]; then
        echo "âŒ Voice configuration file not found"
        return 1
    fi
    
    # Check if command exists in configuration
    if command -v jq &> /dev/null; then
        local exec_command=$(jq -r ".[\"$command\"].exec // empty" "$config_file")
        local feedback=$(jq -r ".[\"$command\"].feedback // empty" "$config_file")
        
        if [[ -n "$exec_command" && "$exec_command" != "null" ]]; then
            echo "ðŸŽ™ï¸ Executing: $command"
            echo "ðŸ’¬ $feedback"
            echo ""
            
            # Set voice context for bridge system
            export CLAUDE_SCRIPT_CONTEXT="voice_control_$command"
            
            # Execute the command
            eval "$exec_command"
            
            local exit_code=$?
            if [[ $exit_code -eq 0 ]]; then
                echo ""
                echo "âœ… Voice command completed successfully"
            else
                echo ""
                echo "âš ï¸ Voice command finished with warnings (exit code: $exit_code)"
            fi
        else
            echo "âŒ Command '$command' not found in voice configuration"
            echo "ðŸ’¡ Use 'help' to see available commands"
        fi
    else
        echo "âš ï¸ jq not available - installing..."
        sudo apt install -y jq
        process_voice_command "$command"
    fi
}

# Interactive voice interface
start_voice_interface() {
    echo "ðŸŽ¤ VOICE INTERFACE READY"
    echo "========================"
    echo ""
    echo "ðŸ’¡ Type a command or say it aloud:"
    echo "   â€¢ Type 'help' for command list"
    echo "   â€¢ Type 'quit' or 'exit' to close"
    echo ""
    
    while true; do
        echo -n "ðŸŽ™ï¸ Voice Command: "
        read -r -t 30 user_input
        
        # Handle timeout or empty input
        if [[ $? -ne 0 ]] || [[ -z "$user_input" ]]; then
            echo ""
            echo "â° Timeout or no input received"
            echo "ðŸ’¡ Type 'help' for commands or 'quit' to exit"
            continue
        fi
        
        case "$user_input" in
            "help"|"commands"|"list")
                show_voice_commands
                ;;
            "quit"|"exit"|"bye")
                echo "ðŸŽ¤ Voice interface closing..."
                if command -v espeak &> /dev/null; then
                    espeak -s 120 "Goodbye! See you later!" 2>/dev/null &
                fi
                break
                ;;
            "test"|"voice bridge test")
                echo "ðŸ§ª Testing bridge integration..."
                export CLAUDE_SCRIPT_CONTEXT="voice_interface_test"
                if is_claude_execution; then
                    echo "âœ… Claude bridge system: ACTIVE"
                else
                    echo "â„¹ï¸ Claude bridge system: STANDBY (manual mode)"
                fi
                echo "âœ… Voice interface: FUNCTIONAL"
                ;;
            *)
                process_voice_command "$user_input"
                ;;
        esac
        
        echo ""
    done
}

# Initialize voice interface
main() {
    # Check dependencies
    if ! command -v espeak &> /dev/null; then
        echo "ðŸ”Š Installing voice synthesis tools..."
        sudo apt install -y espeak espeak-data alsa-utils
    fi
    
    # Welcome message
    if command -v espeak &> /dev/null; then
        espeak -s 120 -p 50 "Bill Sloth enhanced voice interface ready!" 2>/dev/null &
    fi
    
    # Start the interface
    start_voice_interface
}

# Export functions for testing
export -f process_voice_command show_voice_commands

# Run if executed directly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi