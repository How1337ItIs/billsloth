#!/bin/bash
# Ultimate Bill Sloth Integration - The ADHD-friendly, token-saving, ATHF-themed Linux helper

echo "ğŸ¦¥ BILL SLOTH ULTIMATE HELPER"
echo "============================="
echo "ğŸ” Meatwad: 'I understand! Everything is connected now!'"
echo ""

# Initialize all systems
initialize_systems() {
    echo "ğŸš€ Initializing all Bill Sloth systems..."
    
    # Create necessary directories
    mkdir -p ~/bin ~/.billsloth-brain ~/.billsloth-reminders ~/.billsloth-local/{workflows,solutions,patterns}
    
    # Start background services
    echo "ğŸ“¡ Starting adaptive learning..."
    ~/bin/bill-brain smart &
    
    echo "ğŸ”” Activating smart reminders..."
    ~/bin/smart-reminders check-spiral &
    
    echo "ğŸ¯ Loading ATHF personality matrix..."
    sleep 1
    
    echo "âœ… All systems online!"
    echo ""
}

# Smart dashboard that shows everything
show_ultimate_dashboard() {
    clear
    echo -e "\033[35m"
    cat << 'BANNER'
    ğŸ¦¥ BILL SLOTH ULTIMATE CONTROL CENTER ğŸ¦¥
    =========================================
BANNER
    echo -e "\033[0m"
    echo ""
    
    # System status
    echo "ğŸ“Š SYSTEM STATUS:"
    echo "=================="
    
    # VPN status (important for torrenting)
    if ip addr | grep -q "tun\|wg"; then
        echo "ğŸ›¡ï¸ VPN: âœ… ACTIVE (safe for torrenting)"
    else
        echo "ğŸ›¡ï¸ VPN: âŒ INACTIVE (NOT safe for public torrents)"
    fi
    
    # Pattern learning status
    if [ -f ~/.billsloth-brain/activity.log ]; then
        local actions_learned=$(wc -l < ~/.billsloth-brain/activity.log)
        echo "ğŸ§  Learning: $actions_learned patterns recorded"
    else
        echo "ğŸ§  Learning: Just started learning your patterns"
    fi
    
    # Token savings
    if [ -f ~/.billsloth-local/patterns/token_savings.log ]; then
        local local_solutions=$(grep "local_success" ~/.billsloth-local/patterns/token_savings.log | wc -l)
        local claude_calls=$(grep "claude_called" ~/.billsloth-local/patterns/token_savings.log | wc -l)
        echo "ğŸ’° Token Savings: $local_solutions local / $claude_calls Claude calls"
    else
        echo "ğŸ’° Token Savings: No usage data yet"
    fi
    
    # Current time context
    local hour=$(date '+%H')
    local weekday=$(date '+%A')
    echo "â° Context: $weekday, $(date '+%H:%M') - $(get_time_context)"
    
    echo ""
    echo "ğŸ® SMART QUICK ACCESS:"
    echo "======================"
    echo "1) ğŸ¤ Voice Interface (F11) - Just talk to Meatwad!"
    echo "2) ğŸ§  Smart Suggestions - Based on your patterns"
    echo "3) ğŸ  VRBO Management - Guest workflow automation"
    echo "4) ğŸ¬ Streaming Setup - OBS + audio routing"
    echo "5) ğŸ® Gaming Mode - Optimize and launch games"
    echo "6) ğŸ´â€â˜ ï¸ Data Hoarding - Safe torrenting dashboard"
    echo "7) âš¡ Focus Session - ADHD-friendly productivity"
    echo "8) ğŸ”§ System Tools - Updates, fixes, maintenance"
    echo "9) ğŸ’­ Brain Dump - Clear your mental cache"
    echo "0) ğŸ¤– Claude Code - For complex problem solving"
    echo ""
    read -p "ğŸ” Meatwad: Choose what you wanna do: " choice
    
    handle_dashboard_choice "$choice"
}

# Context-aware suggestions
get_time_context() {
    local hour=$(date '+%H')
    
    if [ $hour -ge 6 ] && [ $hour -lt 12 ]; then
        echo "Morning routine time"
    elif [ $hour -ge 12 ] && [ $hour -lt 17 ]; then
        echo "Peak productivity hours"
    elif [ $hour -ge 17 ] && [ $hour -lt 21 ]; then
        echo "Evening tasks"
    else
        echo "Late night mode"
    fi
}

# Handle dashboard choices intelligently
handle_dashboard_choice() {
    local choice="$1"
    
    case "$choice" in
        1)
            echo "ğŸ¤ Starting voice interface..."
            ~/bin/voice-interface
            ;;
        2)
            echo "ğŸ§  Getting smart suggestions..."
            ~/bin/bill-brain suggest
            ;;
        3)
            echo "ğŸ  Opening VRBO management..."
            ~/bin/vrbo-smart-manager
            ;;
        4)
            echo "ğŸ¬ Setting up streaming..."
            ~/bin/stream
            ;;
        5)
            echo "ğŸ® Activating gaming mode..."
            ~/bin/game
            ;;
        6)
            echo "ğŸ´â€â˜ ï¸ Opening data hoarding dashboard..."
            ~/bin/data-dashboard
            ;;
        7)
            echo "âš¡ Starting focus session..."
            ~/bin/focus-timer
            ;;
        8)
            echo "ğŸ”§ System maintenance menu..."
            show_system_menu
            ;;
        9)
            echo "ğŸ’­ Brain dump time..."
            ~/bin/brain-dump
            ;;
        0)
            echo "ğŸ¤– Opening Claude Code lab..."
            cd ~/BillSloth && ./lab.sh
            ;;
        "q"|"quit"|"exit")
            echo "ğŸ” Meatwad: 'Bye! I understand!'"
            exit 0
            ;;
        *)
            echo "ğŸ” Meatwad: 'I don't get that number! Try again!'"
            sleep 2
            show_ultimate_dashboard
            ;;
    esac
}

# System maintenance menu
show_system_menu() {
    echo ""
    echo "ğŸ”§ SYSTEM TOOLS:"
    echo "================"
    echo "a) Update everything"
    echo "b) Fix audio issues"
    echo "c) Check VPN status"
    echo "d) Clean system"
    echo "e) Check system health"
    echo "f) Back to main menu"
    echo ""
    read -p "Choose tool: " tool
    
    case "$tool" in
        a) ~/bin/local-first-router "update system" ;;
        b) ~/bin/local-first-router "fix audio" ;;
        c) ~/bin/local-first-router "check vpn" ;;
        d) sudo apt autoremove -y && sudo apt autoclean ;;
        e) source ~/BillSloth/modules/system_ops.sh && check_system_health ;;
        f) show_ultimate_dashboard ;;
        *) echo "Invalid choice" && sleep 1 && show_system_menu ;;
    esac
}

# Emergency ADHD intervention
adhd_emergency() {
    echo "ğŸš¨ ADHD EMERGENCY MODE ACTIVATED"
    echo "================================="
    echo ""
    echo "ğŸ” Meatwad: 'Hey, it's ok! Let's just do ONE thing.'"
    echo ""
    echo "Quick calming actions:"
    echo "1) ğŸ’­ Brain dump (get it all out of your head)"
    echo "2) â° 15-minute timer (just one small task)"
    echo "3) ğŸµ Background music + simple task"
    echo "4) ğŸš¶ Take a 5-minute walk"
    echo "5) ğŸ’§ Drink water + deep breaths"
    echo ""
    read -p "Pick ONE (1-5): " emergency_choice
    
    case "$emergency_choice" in
        1) ~/bin/brain-dump ;;
        2) echo "â° 15 minutes starting NOW!" && sleep 900 && notify-send "Time's up! Good job!" ;;
        3) echo "ğŸµ Playing focus music..." ;;
        4) echo "ğŸš¶ Go take that walk. I'll be here when you get back." ;;
        5) echo "ğŸ’§ Hydrate and breathe. You got this." ;;
    esac
}

# Command line interface
case "$1" in
    "dashboard"|"")
        initialize_systems
        show_ultimate_dashboard
        ;;
    "emergency"|"help"|"adhd")
        adhd_emergency
        ;;
    "voice")
        ~/bin/voice-interface
        ;;
    "smart")
        ~/bin/local-first-router "$2 $3 $4 $5"
        ;;
    "learn")
        ~/bin/bill-brain analyze
        ;;
    *)
        echo "ğŸ¦¥ Bill Sloth Ultimate Helper"
        echo "Usage:"
        echo "  bill-sloth-ultimate                 - Main dashboard"
        echo "  bill-sloth-ultimate voice           - Voice interface"
        echo "  bill-sloth-ultimate smart <request> - Smart local-first handling"
        echo "  bill-sloth-ultimate emergency       - ADHD emergency mode"
        echo "  bill-sloth-ultimate learn           - Show learned patterns"
        ;;
esac