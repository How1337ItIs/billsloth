#!/bin/bash
# Ultimate Bill Sloth Integration - The ADHD-friendly, token-saving, ATHF-themed Linux helper

echo "ğŸ¦¥ BILL SLOTH ULTIMATE HELPER"
echo "============================="
echo "ğŸ” Meatwad: 'I understand! Everything is connected now!'"
echo ""

# Initialize all systems
initialize_systems() {
    echo "ğŸš€ Initializing all Bill Sloth systems..."
    
    # Create necessary directories
    mkdir -p ~/bin ~/.billsloth-brain ~/.billsloth-reminders ~/.billsloth-local/{workflows,solutions,patterns}
    
    # Initialize Bill Sloth systems
    echo "ğŸ“¡ Starting adaptive learning..."
    source ~/.bill-sloth/lib/adaptive_learning.sh 2>/dev/null && init_adaptive_learning &
    
    echo "ğŸ”” Initializing data persistence..."
    source ~/.bill-sloth/lib/data_persistence.sh 2>/dev/null && init_data_persistence &
    
    echo "ğŸ¯ Loading ATHF personality matrix..."
    sleep 1
    
    echo "âœ… All systems online!"
    echo ""
}

# Smart dashboard that shows everything
show_ultimate_dashboard() {
    clear
    # 1% chance to show Midas Whale lyrics
    if (( RANDOM % 100 == 0 )); then
        echo -e "\033[33m\nğŸ‹âœ¨ Midas Whale ğŸ‘‘ğŸ‹ Easter Egg! âœ¨ğŸ‹\n"
        echo "ğŸ¥š You found a rare Bill Sloth easter egg! Don't tell the whales! ğŸ‹"
        midas_whale_lyrics
        echo -e "\033[0m\n"
    fi
    echo -e "\033[35m"
    cat << 'BANNER'
    ğŸ¦¥ BILL SLOTH ULTIMATE CONTROL CENTER ğŸ¦¥
    =========================================
BANNER
    echo -e "\033[0m"
    echo ""
    
    # System status
    echo "ğŸ“Š SYSTEM STATUS:"
    echo "=================="
    
    # VPN status (important for torrenting)
    if ip addr | grep -q "tun\|wg"; then
        echo "ğŸ›¡ï¸ VPN: âœ… ACTIVE (safe for torrenting)"
    else
        echo "ğŸ›¡ï¸ VPN: âŒ INACTIVE (NOT safe for public torrents)"
    fi
    
    # Pattern learning status  
    if [ -f ~/.bill-sloth/data/bill_sloth.db ]; then
        local usage_count=$(sqlite3 ~/.bill-sloth/data/bill_sloth.db "SELECT COUNT(*) FROM module_usage;" 2>/dev/null || echo "0")
        echo "ğŸ§  Learning: $usage_count usage patterns recorded"
    else
        echo "ğŸ§  Learning: Just started learning your patterns"
    fi
    
    # Task execution status
    if [ -f ~/.bill-sloth/data/bill_sloth.db ]; then
        local success_tasks=$(sqlite3 ~/.bill-sloth/data/bill_sloth.db "SELECT COUNT(*) FROM task_history WHERE status='success';" 2>/dev/null || echo "0")
        local total_tasks=$(sqlite3 ~/.bill-sloth/data/bill_sloth.db "SELECT COUNT(*) FROM task_history;" 2>/dev/null || echo "0")
        echo "ğŸ’° Task Success: $success_tasks / $total_tasks completed successfully"
    else
        echo "ğŸ’° Task Success: No execution data yet"
    fi
    
    # Current time context
    local hour=$(date '+%H')
    local weekday=$(date '+%A')
    echo "â° Context: $weekday, $(date '+%H:%M') - $(get_time_context)"
    
    echo ""
    echo "ğŸ® SMART QUICK ACCESS:"
    echo "======================"
    echo "1) ğŸ¤ Voice Interface (F11) - Just talk to Meatwad!"
    echo "2) ğŸ§  Smart Suggestions - Based on your patterns"
    echo "3) ğŸ  VRBO Management - Guest workflow automation"
    echo "4) ğŸ¬ Streaming Setup - OBS + audio routing"
    echo "5) ğŸ® Gaming Mode - Optimize and launch games"
    echo "6) ğŸ´â€â˜ ï¸ Data Hoarding - Safe torrenting dashboard"
    echo "7) âš¡ Focus Session - ADHD-friendly productivity"
    echo "8) ğŸ”§ System Tools - Updates, fixes, maintenance"
    echo "9) ğŸ’­ Brain Dump - Clear your mental cache"
    echo "0) ğŸ¤– Claude Code - For complex problem solving"
    echo ""
    read -p "ğŸ” Meatwad: Choose what you wanna do: " choice
    
    handle_dashboard_choice "$choice"
}

# Context-aware suggestions
get_time_context() {
    local hour=$(date '+%H')
    
    if [ $hour -ge 6 ] && [ $hour -lt 12 ]; then
        echo "Morning routine time"
    elif [ $hour -ge 12 ] && [ $hour -lt 17 ]; then
        echo "Peak productivity hours"
    elif [ $hour -ge 17 ] && [ $hour -lt 21 ]; then
        echo "Evening tasks"
    else
        echo "Late night mode"
    fi
}

# Handle dashboard choices intelligently
handle_dashboard_choice() {
    local choice="$1"
    
    case "$choice" in
        1)
            echo "ğŸ¤ Starting voice interface..."
            bash ~/.bill-sloth/modules/voice_assistant_interactive.sh
            ;;
        2)
            echo "ğŸ§  Getting smart suggestions..."
            source ~/.bill-sloth/lib/adaptive_learning.sh && show_suggestions
            ;;
        3)
            echo "ğŸ  Opening VRBO management..."
            bash ~/.bill-sloth/modules/vacation_rental_manager_interactive.sh
            ;;
        4)
            echo "ğŸ¬ Setting up streaming..."
            bash ~/.bill-sloth/modules/streaming_setup_interactive.sh
            ;;
        5)
            echo "ğŸ® Activating gaming mode..."
            bash ~/.bill-sloth/modules/gaming_boost_interactive.sh
            ;;
        6)
            echo "ğŸ´â€â˜ ï¸ Opening data hoarding dashboard..."
            bash ~/.bill-sloth/modules/data_hoarding_interactive.sh
            ;;
        7)
            echo "âš¡ Starting focus session..."
            bash ~/.bill-sloth/modules/productivity_suite_interactive.sh
            ;;
        8)
            echo "ğŸ”§ System maintenance menu..."
            show_system_menu
            ;;
        9)
            echo "ğŸ’­ Brain dump time..."
            source ~/.bill-sloth/lib/data_persistence.sh && store_data "brain_dump" "$(date +%s)" "$(zenity --entry --text='Brain dump:' 2>/dev/null || read -p 'Brain dump: ' && echo $REPLY)"
            echo "ğŸ’­ Brain dump saved!"
            ;;
        0)
            echo "ğŸ¤– Opening Claude Code lab..."
            cd ~/.bill-sloth && bash lab.sh
            ;;
        "q"|"quit"|"exit")
            echo "ğŸ” Meatwad: 'Bye! I understand!'"
            exit 0
            ;;
        *)
            echo "ğŸ” Meatwad: 'I don't get that number! Try again!'"
            sleep 2
            show_ultimate_dashboard
            ;;
    esac
}

# System maintenance menu
show_system_menu() {
    echo ""
    echo "ğŸ”§ SYSTEM TOOLS:"
    echo "================"
    echo "a) Update everything"
    echo "b) Fix audio issues"
    echo "c) Check VPN status"
    echo "d) Clean system"
    echo "e) Check system health"
    echo "f) Back to main menu"
    echo ""
    read -p "Choose tool: " tool
    
    case "$tool" in
        a) bash ~/.bill-sloth/modules/system_ops_interactive.sh ;;
        b) bash ~/.bill-sloth/modules/system_doctor_interactive.sh ;;
        c) bash ~/.bill-sloth/modules/network_management_interactive.sh ;;
        d) bash ~/.bill-sloth/modules/system_doctor_interactive.sh ;;
        e) source ~/.bill-sloth/lib/system_health_monitoring.sh && check_system_health ;;
        f) show_ultimate_dashboard ;;
        *) echo "Invalid choice" && sleep 1 && show_system_menu ;;
    esac
}

# Emergency ADHD intervention
adhd_emergency() {
    echo "ğŸš¨ ADHD EMERGENCY MODE ACTIVATED"
    echo "================================="
    echo ""
    echo "ğŸ” Meatwad: 'Hey, it's ok! Let's just do ONE thing.'"
    echo ""
    echo "Quick calming actions:"
    echo "1) ğŸ’­ Brain dump (get it all out of your head)"
    echo "2) â° 15-minute timer (just one small task)"
    echo "3) ğŸµ Background music + simple task"
    echo "4) ğŸš¶ Take a 5-minute walk"
    echo "5) ğŸ’§ Drink water + deep breaths"
    echo ""
    read -p "Pick ONE (1-5): " emergency_choice
    
    case "$emergency_choice" in
        1) ~/bin/brain-dump ;;
        2) echo "â° 15 minutes starting NOW!" && sleep 900 && notify-send "Time's up! Good job!" ;;
        3) echo "ğŸµ Playing focus music..." ;;
        4) echo "ğŸš¶ Go take that walk. I'll be here when you get back." ;;
        5) echo "ğŸ’§ Hydrate and breathe. You got this." ;;
    esac
}

# Midas Whale ğŸ‘‘ğŸ‹ Easter Egg Lyrics (hidden)
midas_whale_lyrics() {
  cat <<'EOF'
Great North Special, were you on board?
You can't find a ride like that no more
Night the chariot swung down low
Ninety nine children had a chance to go

One long party from front to end
Tune to the whistle going round the bend
No big hurry, what do you say
Midas Whale ğŸ‘‘ğŸ‹ travel the elegant way

Midas Whale ğŸ‘‘ğŸ‹, Midas Whale ğŸ‘‘ğŸ‹
(Midas Whale ğŸ‘‘ğŸ‹, Midas Whale ğŸ‘‘ğŸ‹)
Midas Whale ğŸ‘‘ğŸ‹, Midas Whale ğŸ‘‘ğŸ‹
(Midas Whale ğŸ‘‘ğŸ‹, Midas Whale ğŸ‘‘ğŸ‹)
Midas Whale ğŸ‘‘ğŸ‹, Midas Whale ğŸ‘‘ğŸ‹
(Midas Whale ğŸ‘‘ğŸ‹, Midas Whale ğŸ‘‘ğŸ‹)
Midas Whale ğŸ‘‘ğŸ‹, Midas Whale ğŸ‘‘ğŸ‹
(Midas Whale ğŸ‘‘ğŸ‹, Midas Whale ğŸ‘‘ğŸ‹)

Ragtime solid for twenty five miles
Then slip over to the Cajun style
Bar car loaded with rhythm and blues
Rock and roll wailing in the old caboose

Long train running from coast to coast
Bringing 'long the party where they need it the most
Whup on the box car, beat on the bell
Nothing else shaking so you Midas Whale ğŸ‘‘ğŸ‹

Never had such a good time
In my life before
I'd like to have it one time more
One good ride from start to end
I'd like to take that ride again

Run out of track and I caught the plane
Back in the county with the blues again
Great North Special been on my mind
Midas Whale ğŸ‘‘ğŸ‹ ride it just one more time
EOF
}

# Command line interface
case "$1" in
    "dashboard"|"")
        initialize_systems
        show_ultimate_dashboard
        ;;
    "emergency"|"help"|"adhd")
        adhd_emergency
        ;;
    "voice")
        ~/bin/voice-interface
        ;;
    "smart")
        ~/bin/local-first-router "$2 $3 $4 $5"
        ;;
    "learn")
        ~/bin/bill-brain analyze
        ;;
    *)
        echo "ğŸ¦¥ Bill Sloth Ultimate Helper"
        echo "Usage:"
        echo "  bill-sloth-ultimate                 - Main dashboard"
        echo "  bill-sloth-ultimate voice           - Voice interface"
        echo "  bill-sloth-ultimate smart <request> - Smart local-first handling"
        echo "  bill-sloth-ultimate emergency       - ADHD emergency mode"
        echo "  bill-sloth-ultimate learn           - Show learned patterns"
        ;;
esac